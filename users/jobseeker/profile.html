<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: { extend: { colors: { primary: "#407bff" } } },
      };
    </script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body class="bg-gray-50 font-sans">
    <!-- NAVBAR -->
    <nav class="bg-white shadow-sm sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <h1 class="text-2xl font-bold text-primary">JobPortal</h1>
            <div class="hidden md:flex ml-10 space-x-8">
              <a
                href="dashboard.html"
                class="text-gray-500 hover:text-gray-700 px-1 pt-1 text-sm font-medium"
                >Find Jobs</a
              >
              <a
                href="my_applications.html"
                class="text-gray-500 hover:text-gray-700 px-1 pt-1 text-sm font-medium"
                >My Applications</a
              >
              <a
                href="profile.html"
                class="text-gray-900 border-b-2 border-primary px-1 pt-1 text-sm font-medium"
                >Profile</a
              >
            </div>
          </div>
          <button id="logoutBtn" class="text-red-500 font-medium">
            Logout
          </button>
        </div>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="max-w-4xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
      <div class="bg-white shadow-lg rounded-xl overflow-hidden">
        <!-- Header Banner -->
        <div class="bg-primary h-32 w-full relative">
          <div class="absolute -bottom-10 left-8 group">
            <!-- AVATAR CONTAINER -->
            <div
              class="w-24 h-24 bg-white rounded-full p-1 shadow-md relative cursor-pointer overflow-hidden"
              onclick="document.getElementById('profilePicInput').click()"
            >
              <!-- Image or Initial -->
              <img
                id="avatar-img"
                src=""
                class="w-full h-full rounded-full object-cover hidden"
              />
              <div
                id="avatar-initial-box"
                class="w-full h-full bg-gray-200 rounded-full flex items-center justify-center text-gray-500 text-2xl font-bold"
              >
                <span id="avatar-initial">U</span>
              </div>

              <!-- Overlay on Hover -->
              <div
                class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition rounded-full"
              >
                <i class="fas fa-camera text-white"></i>
              </div>
            </div>

            <!-- Hidden File Input -->
            <input
              type="file"
              id="profilePicInput"
              accept="image/*"
              class="hidden"
            />
          </div>
        </div>

        <div class="pt-12 px-8 pb-8">
          <div class="flex justify-between items-start">
            <div>
              <h2 class="text-2xl font-bold text-gray-800" id="display-name">
                Loading...
              </h2>
              <p class="text-gray-500 text-sm" id="display-email">
                loading@example.com
              </p>
            </div>
            <!-- PREVIEW BUTTON -->
            <button
              id="previewBtn"
              class="text-primary border border-primary px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-50 transition"
            >
              <i class="far fa-eye mr-2"></i> Preview Public Profile
            </button>
          </div>

          <hr class="my-6 border-gray-100" />

          <form id="profileForm" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-gray-700 font-medium mb-2 text-sm"
                  >First Name</label
                >
                <input
                  type="text"
                  id="first_name"
                  required
                  class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary outline-none"
                />
              </div>
              <div>
                <label class="block text-gray-700 font-medium mb-2 text-sm"
                  >Last Name</label
                >
                <input
                  type="text"
                  id="last_name"
                  required
                  class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary outline-none"
                />
              </div>
            </div>

            <div>
              <label class="block text-gray-700 font-medium mb-2 text-sm"
                >Professional Headline / Bio</label
              >
              <textarea
                id="bio"
                rows="3"
                placeholder="e.g. Passionate Web Developer..."
                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary outline-none"
              ></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-gray-700 font-medium mb-2 text-sm"
                  >Skills (Comma separated)</label
                >
                <input
                  type="text"
                  id="skills"
                  placeholder="HTML, CSS, JS"
                  class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary outline-none"
                />
              </div>
              <div>
                <label class="block text-gray-700 font-medium mb-2 text-sm"
                  >Experience</label
                >
                <select
                  id="experience"
                  class="w-full px-4 py-2 border rounded-lg bg-white focus:ring-2 focus:ring-primary outline-none"
                >
                  <option value="Fresher">Fresher</option>
                  <option value="1-2 Years">1-2 Years</option>
                  <option value="3-5 Years">3-5 Years</option>
                  <option value="5+ Years">5+ Years</option>
                </select>
              </div>
            </div>

            <div>
              <label class="block text-gray-700 font-medium mb-2 text-sm"
                >Highest Education</label
              >
              <input
                type="text"
                id="education"
                placeholder="e.g. BSc Computer Science"
                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary outline-none"
              />
            </div>

            <div class="flex justify-end">
              <button
                type="submit"
                id="saveBtn"
                class="bg-primary hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow-md transition"
              >
                Save Changes
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- PREVIEW MODAL (Same as Employer View) -->
    <div
      id="profileModal"
      class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden flex items-center justify-center z-[60] backdrop-blur-md"
    >
      <div
        class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden transform scale-95 opacity-0 transition-all duration-300 relative"
        id="profileContent"
      >
        <button
          onclick="closeModal()"
          class="absolute top-4 right-4 bg-white/80 hover:bg-white p-2 rounded-full shadow-sm z-10 transition"
        >
          <i class="fas fa-times text-gray-600"></i>
        </button>
        <div class="h-32 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
        <div class="px-8 pb-8 -mt-12 relative">
          <div class="w-24 h-24 bg-white rounded-full p-1 shadow-lg mb-4">
            <!-- PREVIEW AVATAR -->
            <img
              id="prev-avatar-img"
              src=""
              class="w-full h-full rounded-full object-cover hidden"
            />
            <div
              id="prev-avatar-box"
              class="w-full h-full bg-gray-100 rounded-full flex items-center justify-center text-3xl font-bold text-gray-400"
            >
              U
            </div>
          </div>
          <div class="flex justify-between items-start mb-6">
            <div>
              <h2 class="text-2xl font-bold text-gray-900" id="prev-name">
                Name
              </h2>
              <p class="text-gray-500" id="prev-headline">Role</p>
            </div>
          </div>
          <div class="mb-4">
            <p class="text-gray-600 text-sm" id="prev-bio">Bio...</p>
          </div>
          <div id="prev-skills" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </div>

    <!-- SCRIPT -->
    <script>
      let currentProfileData = {};

      document.addEventListener("DOMContentLoaded", async () => {
        // LOGOUT
        document
          .getElementById("logoutBtn")
          .addEventListener("click", async () => {
            await fetch("../../api/logout.php");
            window.location.href = "../../auth/login.html";
          });

        // LOAD PROFILE
        try {
          const res = await fetch("../../api/users/profile.php");
          const result = await res.json();

          if (result.status && result.data) {
            const user = result.data;
            currentProfileData = user;

            // Fill Header
            document.getElementById("display-name").innerText =
              `${user.first_name} ${user.last_name}`;
            document.getElementById("display-email").innerText = user.email;

            // Avatar Logic
            if (user.profile_pic) {
              document.getElementById("avatar-img").src =
                "../../api/" + user.profile_pic;
              document.getElementById("avatar-img").classList.remove("hidden");
              document
                .getElementById("avatar-initial-box")
                .classList.add("hidden");
            } else {
              document.getElementById("avatar-initial").innerText =
                user.first_name.charAt(0);
            }

            // Fill Form
            document.getElementById("first_name").value = user.first_name;
            document.getElementById("last_name").value = user.last_name;
            document.getElementById("bio").value = user.bio || "";
            document.getElementById("skills").value = user.skills || "";
            document.getElementById("education").value = user.education || "";
            if (user.experience)
              document.getElementById("experience").value = user.experience;
          }
        } catch (err) {
          console.error(err);
        }

        // SAVE PROFILE (Including Image)
        document
          .getElementById("profileForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const btn = document.getElementById("saveBtn");
            btn.innerText = "Saving...";
            btn.disabled = true;

            const formData = new FormData();
            formData.append(
              "first_name",
              document.getElementById("first_name").value,
            );
            formData.append(
              "last_name",
              document.getElementById("last_name").value,
            );
            formData.append("bio", document.getElementById("bio").value);
            formData.append("skills", document.getElementById("skills").value);
            formData.append(
              "experience",
              document.getElementById("experience").value,
            );
            formData.append(
              "education",
              document.getElementById("education").value,
            );

            // Check file
            const fileInput = document.getElementById("profilePicInput");
            if (fileInput.files.length > 0) {
              formData.append("profile_pic", fileInput.files[0]);
            }

            try {
              const res = await fetch("../../api/users/profile.php", {
                method: "POST",
                body: formData, // Sending FormData, NOT JSON
              });
              const result = await res.json();
              alert(result.message);
              location.reload(); // Reload to show new image
            } catch (err) {
              alert("Error saving profile");
            } finally {
              btn.innerText = "Save Changes";
              btn.disabled = false;
            }
          });

        // PREVIEW BUTTON
        document.getElementById("previewBtn").addEventListener("click", () => {
          const modal = document.getElementById("profileModal");
          const content = document.getElementById("profileContent");

          // Fill Preview Data
          document.getElementById("prev-name").innerText =
            document.getElementById("first_name").value +
            " " +
            document.getElementById("last_name").value;
          document.getElementById("prev-headline").innerText = "Job Seeker";
          document.getElementById("prev-bio").innerText =
            document.getElementById("bio").value;

          // Preview Avatar
          const fileInput = document.getElementById("profilePicInput");
          if (fileInput.files.length > 0) {
            // Show local preview of new image
            const reader = new FileReader();
            reader.onload = function (e) {
              document.getElementById("prev-avatar-img").src = e.target.result;
              document
                .getElementById("prev-avatar-img")
                .classList.remove("hidden");
              document
                .getElementById("prev-avatar-box")
                .classList.add("hidden");
            };
            reader.readAsDataURL(fileInput.files[0]);
          } else if (currentProfileData.profile_pic) {
            // Show saved image
            document.getElementById("prev-avatar-img").src =
              "../../api/" + currentProfileData.profile_pic;
            document
              .getElementById("prev-avatar-img")
              .classList.remove("hidden");
            document.getElementById("prev-avatar-box").classList.add("hidden");
          } else {
            // Show Initial
            document.getElementById("prev-avatar-box").innerText = document
              .getElementById("first_name")
              .value.charAt(0);
            document.getElementById("prev-avatar-img").classList.add("hidden");
            document
              .getElementById("prev-avatar-box")
              .classList.remove("hidden");
          }

          // Skills
          const skills = document.getElementById("skills").value.split(",");
          const skillsContainer = document.getElementById("prev-skills");
          skillsContainer.innerHTML = "";
          skills.forEach((s) => {
            if (s.trim())
              skillsContainer.innerHTML += `<span class="bg-gray-100 px-2 py-1 rounded text-xs border">${s.trim()}</span>`;
          });

          modal.classList.remove("hidden");
          setTimeout(() => {
            content.classList.remove("scale-95", "opacity-0");
            content.classList.add("scale-100", "opacity-100");
          }, 10);
        });
      });

      function closeModal() {
        const modal = document.getElementById("profileModal");
        const content = document.getElementById("profileContent");
        content.classList.remove("scale-100", "opacity-100");
        content.classList.add("scale-95", "opacity-0");
        setTimeout(() => modal.classList.add("hidden"), 300);
      }
    </script>
  </body>
</html>
